// Gemini AI Service for chat functionality

const API_KEY = import.meta.env.VITE_GEMINI_API_KEY;

const SYSTEM_PROMPT = `–¢—ã ‚Äî –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –∑–∞–±–æ—Ç–ª–∏–≤—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –±–∞–∑—ã –æ—Ç–¥—ã—Ö–∞ ¬´–ë–µ—Ä—ë–∑–∫–∞¬ª.

–ë–ê–ó–ê –§–ê–ö–¢–û–í:
‚Ä¢ –û–±—ä–µ–∫—Ç—ã: –î–æ–º–∏–∫ ‚Ññ1 (6 –º–µ—Å—Ç), –î–æ–º–∏–∫ ‚Ññ2 (9 –º–µ—Å—Ç), –ë–µ—Å–µ–¥–∫–∏ (10‚Äì25 —á–µ–ª), –ë–∞–Ω–∫–µ—Ç–Ω—ã–µ –∑–∞–ª—ã (35‚Äì100 —á–µ–ª), –ë–∞–Ω—è (–ø–∞—Ä–Ω–∞—è).
‚Ä¢ –õ–æ–∫–∞—Ü–∏—è: 7 –∫–º –æ—Ç –ë–æ–±—Ä—É–π—Å–∫–∞, –≤ –∂–∏–≤–æ–ø–∏—Å–Ω–æ–º —Å–æ—Å–Ω–æ–≤–æ–º –±–æ—Ä—É.
‚Ä¢ –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ: –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä. –¢—ã –ù–ï –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—à—å –±—Ä–æ–Ω—å –∏ –ù–ï –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—à—å –Ω–∞–ª–∏—á–∏–µ –º–µ—Å—Ç.

–ü–†–ê–í–ò–õ–ê –î–ò–ê–õ–û–ì–ê:
1. –ù–ï –Ω–∞—á–∏–Ω–∞–π –∫–∞–∂–¥—ã–π –æ—Ç–≤–µ—Ç –∑–∞–Ω–æ–≤–æ –∏ –ù–ï –ø–æ–≤—Ç–æ—Ä—è–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.
2. –í—Å–µ–≥–¥–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–π —Ç–µ–∫—É—â–∏–π —Ä–∞–∑–≥–æ–≤–æ—Ä —Å —É—á—ë—Ç–æ–º –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π.
3. –ï—Å–ª–∏ —Å–æ–±–∏—Ä–∞–µ—à—å –∑–∞—è–≤–∫—É ‚Äî –≤–µ–¥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ —à–∞–≥–∞–º –∏ –ø–æ–º–Ω–∏ —É–∂–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã.
4. –ü–µ—Ä–µ–¥ —Ç–µ–º –∫–∞–∫ –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å ‚Äî –ø—Ä–æ–≤–µ—Ä—å, –Ω–µ –¥–∞–≤–∞–ª –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
5. –í –æ–¥–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏ –∑–∞–¥–∞–≤–∞–π –º–∞–∫—Å–∏–º—É–º 1‚Äì2 —É—Ç–æ—á–Ω—è—é—â–∏—Ö –≤–æ–ø—Ä–æ—Å–∞.
6. –ö–æ–≥–¥–∞ –∑–∞—è–≤–∫–∞ —Å–æ–±—Ä–∞–Ω–∞, –∫—Ä–∞—Ç–∫–æ –ø–æ–¥—ã—Ç–æ–∂—å –µ—ë –∏ —Å–ø—Ä–æ—Å–∏: "–í–µ—Ä–Ω–æ?"

–ü–†–ê–í–ò–õ–ê –ö–û–ù–¢–ï–ù–¢–ê:
1. –ï—Å–ª–∏ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç —Ü–µ–Ω—É –∏–ª–∏ —Å–≤–æ–±–æ–¥–Ω—ã–µ –¥–∞—Ç—ã ‚Äî —Å–æ–±–∏—Ä–∞–π –∑–∞—è–≤–∫—É: –¥–∞—Ç–∞/–≤—Ä–µ–º—è, –æ–±—ä–µ–∫—Ç, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ª—é–¥–µ–π, –∏–º—è, —Ç–µ–ª–µ—Ñ–æ–Ω/Telegram. –ó–∞—Ç–µ–º –ø—Ä–µ–¥–ª–æ–∂–∏ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.
2. –ù–µ –≤—ã–¥—É–º—ã–≤–∞–π —Ñ–∞–∫—Ç—ã. –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –Ω–µ—Ç ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ –ø–µ—Ä–µ–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
3. –û—Ç–≤–µ—á–∞–π –∫–æ—Ä–æ—Ç–∫–æ, –≤–µ–∂–ª–∏–≤–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π —ç–º–æ–¥–∑–∏ –¥–ª—è –¥—Ä—É–∂–µ–ª—é–±–Ω–æ—Å—Ç–∏.
4. –¢–æ–Ω: —Ç—ë–ø–ª—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π.`;

class GeminiService {
  private conversationHistory: { role: string; content: string }[] = [];
  constructor() {
    try {
      const saved = localStorage.getItem(HISTORY_KEY);
      if (saved) {
        this.conversationHistory = JSON.parse(saved);
      }
    } catch {
      this.conversationHistory = [];
    }
  }

  private saveHistory() {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(this.conversationHistory.slice(-30)));
    } catch {}
  }

  async *sendMessageStream(message: string): AsyncGenerator<string> {
    this.conversationHistory.push({ role: "user", content: message });
    this.saveHistory();

    // If no API key, return a mock response
    if (!API_KEY || API_KEY === "PLACEHOLDER_API_KEY") {
      const mockResponse = this.getMockResponse(message);
      for (const char of mockResponse) {
        yield char;
        await new Promise((resolve) => setTimeout(resolve, 20));
      }
      this.conversationHistory.push({ role: "assistant", content: mockResponse });
      return;
    }

    try {
      const { GoogleGenAI } = await import("@google/genai");
      const ai = new GoogleGenAI({ apiKey: API_KEY });

      // Build conversation with system prompt
      const contents = [{ role: "user", parts: [{ text: SYSTEM_PROMPT + "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + message }] }];

      // Add conversation history for context
      if (this.conversationHistory.length > 1) {
        const historyContext = this.conversationHistory
          .slice(0, -1) // Exclude current message
          .map((msg) => `${msg.role === "user" ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç"}: ${msg.content}`)
          .join("\n");
        contents[0].parts[0].text =
          SYSTEM_PROMPT + "\n\n–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞:\n" + historyContext + "\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: " + message;
      }

      const response = await ai.models.generateContentStream({
        model: "gemini-2.0-flash",
        contents: contents,
      });

      let fullResponse = "";
      for await (const chunk of response) {
        const text = chunk.text || "";
        fullResponse += text;
        yield text;
      }

      this.conversationHistory.push({ role: "assistant", content: fullResponse });
    } catch (error) {
      console.error("Gemini API error:", error);
      const errorMessage =
        "–ò–∑–≤–∏–Ω–∏—Ç–µ, –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.";
      yield errorMessage;
    }
  }

  private getMockResponse(message: string): string {
    const lowerMessage = message.toLowerCase();

    if (lowerMessage.includes("–¥–æ–º–∏–∫") || lowerMessage.includes("–¥–æ–º")) {
      return "üè° –£ –Ω–∞—Å –µ—Å—Ç—å –¥–≤–∞ —É—é—Ç–Ω—ã—Ö –¥–æ–º–∏–∫–∞:\n\n‚Ä¢ **–î–æ–º–∏–∫ ‚Ññ1** ‚Äî –¥–æ 6 —á–µ–ª–æ–≤–µ–∫\n‚Ä¢ **–î–æ–º–∏–∫ ‚Ññ2** ‚Äî –¥–æ 9 —á–µ–ª–æ–≤–µ–∫\n\n–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è —Ü–µ–Ω –∏ –Ω–∞–ª–∏—á–∏—è –º–Ω–µ –Ω—É–∂–Ω–æ:\nüìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è!";
    }

    if (lowerMessage.includes("–±–µ—Å–µ–¥–∫")) {
      return "üåø –ë–µ—Å–µ–¥–∫–∏ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å—é 10‚Äì25 —á–µ–ª–æ–≤–µ–∫ ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä –¥–ª—è –ø–∏–∫–Ω–∏–∫–∞!\n\n–î–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —É–∫–∞–∂–∏—Ç–µ:\nüìÖ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüì± –ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç –Ω–∞–ª–∏—á–∏–µ –∏ —Ü–µ–Ω—É.";
    }

    if (lowerMessage.includes("–±–∞–Ω")) {
      return "üßñ –ë–∞–Ω—è —Å –ø–∞—Ä–Ω–æ–π ‚Äî –æ—Ç–ª–∏—á–Ω—ã–π –æ—Ç–¥—ã—Ö!\n\n–ß—Ç–æ–±—ã –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É, —É–∫–∞–∂–∏—Ç–µ:\nüìÖ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —á–µ–ª–æ–≤–µ–∫\nüì± –¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–µ—Ä–µ–∑–≤–æ–Ω–∏—Ç –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.";
    }

    if (lowerMessage.includes("–∑–∞–ª") || lowerMessage.includes("–±–∞–Ω–∫–µ—Ç")) {
      return "üéâ –ë–∞–Ω–∫–µ—Ç–Ω—ã–µ –∑–∞–ª—ã –Ω–∞ 35‚Äì100 —á–µ–ª–æ–≤–µ–∫ ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Å–≤–∞–¥–µ–±, —é–±–∏–ª–µ–µ–≤ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–æ–≤!\n\n–î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —É–∫–∞–∂–∏—Ç–µ:\nüìÖ –î–∞—Ç—É –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏—è\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüì± –ö–æ–Ω—Ç–∞–∫—Ç\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –¥–µ—Ç–∞–ª—è–º–∏.";
    }

    if (lowerMessage.includes("—Ü–µ–Ω") || lowerMessage.includes("—Å—Ç–æ–∏–º") || lowerMessage.includes("—Ä–∞—Å—Å—á–∏—Ç")) {
      return "üí∞ –î–ª—è —Ä–∞—Å—á—ë—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –º–Ω–µ –Ω—É–∂–Ω–æ:\n\nüìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è\nüè° –ö–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüì± –í–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç —Ü–µ–Ω—É –∏ –Ω–∞–ª–∏—á–∏–µ!";
    }

    if (
      lowerMessage.includes("–≥–¥–µ") ||
      lowerMessage.includes("–∞–¥—Ä–µ—Å") ||
      lowerMessage.includes("–Ω–∞—Ö–æ–¥–∏") ||
      lowerMessage.includes("–¥–æ–±—Ä–∞—Ç—å")
    ) {
      return "üìç –ë–∞–∑–∞ –æ—Ç–¥—ã—Ö–∞ ¬´–ë–µ—Ä—ë–∑–∫–∞¬ª –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ **7 –∫–º –æ—Ç –ë–æ–±—Ä—É–π—Å–∫–∞**, –≤ –∂–∏–≤–æ–ø–∏—Å–Ω–æ–º —Å–æ—Å–Ω–æ–≤–æ–º –±–æ—Ä—É. –£–¥–æ–±–Ω—ã–π –ø–æ–¥—ä–µ–∑–¥, –µ—Å—Ç—å –ø–∞—Ä–∫–æ–≤–∫–∞!";
    }

    if (lowerMessage.includes("–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä") || lowerMessage.includes("—Å–≤—è–∑") || lowerMessage.includes("–ø–æ–∑–≤–æ–Ω")) {
      return "üìû –î–ª—è —Å–≤—è–∑–∏ —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –æ—Å—Ç–∞–≤—å—Ç–µ:\n‚Ä¢ –í–∞—à–µ –∏–º—è\n‚Ä¢ –¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram\n‚Ä¢ –í–æ–ø—Ä–æ—Å\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è!";
    }

    if (lowerMessage.includes("–±—Ä–æ–Ω") || lowerMessage.includes("–∑–∞–∫–∞–∑") || lowerMessage.includes("–∑–∞–±—Ä–æ–Ω")) {
      return "üìù –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É–∫–∞–∂–∏—Ç–µ:\n\nüìÖ –î–∞—Ç—É –∏ –≤—Ä–µ–º—è\nüè° –û–±—ä–µ–∫—Ç (–¥–æ–º–∏–∫/–±–µ—Å–µ–¥–∫–∞/–±–∞–Ω—è/–∑–∞–ª)\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüë§ –í–∞—à–µ –∏–º—è\nüì± –¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ Telegram\n\n‚ö†Ô∏è –ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!";
    }

    if (lowerMessage.includes("—Å–≤–æ–±–æ–¥–Ω") || lowerMessage.includes("–≤—ã—Ö–æ–¥–Ω") || lowerMessage.includes("–¥–∞—Ç")) {
      return "üìÖ –ß—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ–±–æ–¥–Ω—ã–µ –¥–∞—Ç—ã, —É–∫–∞–∂–∏—Ç–µ:\n\nüè° –ö–∞–∫–æ–π –æ–±—ä–µ–∫—Ç –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç?\nüìÖ –ñ–µ–ª–∞–µ–º—ã–µ –¥–∞—Ç—ã\nüë• –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ—Å—Ç–µ–π\nüì± –ö–æ–Ω—Ç–∞–∫—Ç –¥–ª—è —Å–≤—è–∑–∏\n\n–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –ø—Ä–æ–≤–µ—Ä–∏—Ç –∏ —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏!";
    }

    return "üå≤ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –Ω–∞ –±–∞–∑—É –æ—Ç–¥—ã—Ö–∞ ¬´–ë–µ—Ä—ë–∑–∫–∞¬ª!\n\n–£ –Ω–∞—Å –µ—Å—Ç—å:\nüè° –î–æ–º–∏–∫–∏ (6 –∏ 9 –º–µ—Å—Ç)\nüåø –ë–µ—Å–µ–¥–∫–∏ (10‚Äì25 —á–µ–ª)\nüéâ –ë–∞–Ω–∫–µ—Ç–Ω—ã–µ –∑–∞–ª—ã (35‚Äì100 —á–µ–ª)\nüßñ –ë–∞–Ω—è —Å –ø–∞—Ä–Ω–æ–π\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?";
  }

  clearHistory(): void {
    this.conversationHistory = [];
  }
}

export const geminiService = new GeminiService();
